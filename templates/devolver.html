{% extends 'base.html' %}

{% block title %}Registrar Devolução — Biblioteca{% endblock %}

{% block content %}
  <h2>Devolução</h2>
  <form class="form-card" method="get" action="/devolver" style="padding:12px;">
    <label style="flex:1">Matrícula:
      <input name="matricula" placeholder="Matrícula do Leitor">
    </label>
    <div class="actions" style="width:auto">
      <button class="btn" type="submit">Pesquisar</button>
      <a class="btn" href="/">Voltar</a>
    </div>
  </form>

  {% if leitor and leitor_locs %}
    <h3>Locações Ativas de {{ leitor.nome }} ({{ leitor.matricula }})</h3>
    <table class="data-table">
      <thead><tr><th>Livro</th><th>Código</th><th>Data Locação</th><th>Prev. Devolução</th><th>Dias Restantes</th><th>Ação</th></tr></thead>
      <tbody>
        {% for it in leitor_locs %}
          <tr>
            <td>{{ it.livro_title }}</td>
            <td>{{ it.livro_isbn }}</td>
            <td>{{ it.loc_date }}</td>
            <td>{{ it.devolucao }}</td>
            <td>{{ it.days_remaining }}</td>
            <td>
              <form method="post" action="/devolver">
                <input type="hidden" name="locacao_id" value="{{ it.loc_id }}">
                <button class="btn primary" type="submit">Devolver</button>
              </form>
            </td>
          </tr>
        {% endfor %}
      </tbody>
    </table>
  {% elif leitor %}
    <p>Nenhuma locação ativa encontrada para {{ leitor.nome }}.</p>
  {% endif %}
{% endblock %}

{% block scripts %}
<script>
  (function(){
    const form = document.querySelector('form');
    const error = document.createElement('div');
    error.className = 'form-error';
    form.insertBefore(error, form.firstChild);

    form.addEventListener('submit', function(e){
      error.style.display='none'; error.textContent='';
      form.querySelectorAll('.input-invalid').forEach(i=> i.classList.remove('input-invalid'));
      const mat = form.querySelector('input[name="matricula"]');
      const isbn = form.querySelector('input[name="isbn"]');
      const data = form.querySelector('input[name="data_real"]');
      const problems = [];
      if(!mat.value.trim()){ problems.push('Informe a matrícula do leitor'); mat.classList.add('input-invalid') }
      if(!isbn.value.trim()){ problems.push('Informe o ISBN do livro'); isbn.classList.add('input-invalid') }
      if(!data.value.trim()){ problems.push('Informe a data da devolução'); data.classList.add('input-invalid') }
      if(problems.length){ e.preventDefault(); error.innerHTML = problems.map(p=>`<div>• ${p}</div>`).join(''); error.style.display='block'; error.scrollIntoView({behavior:'smooth', block:'center'}); }
    });
  })();
</script>
{% endblock %}
